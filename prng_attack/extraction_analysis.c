#include "chacha_prng.h"
#include "common.h"

#include <proc/readproc.h>

// batched_entropy. defined one per cpu
struct batched_entropy {
        union {
                unsigned long entropy_long[CHACHA20_BLOCK_SIZE / sizeof(unsigned long)];
                unsigned int entropy_int[CHACHA20_BLOCK_SIZE / sizeof(unsigned int)];
        };
        unsigned int position;
};

struct batched_entropy batched_entropy_long;

void analyze_extractions(struct extractions ex, ull previous_read_time, ull current_read_time) {
	// for now, just classify extractions based on known types. 
	// ex. a 64, non-backtracked extraction is likely a reseeding of batched_entropy
	int i;
	for (i = 0; i < ex.num_extractions; ++i) {
		if (ex.extractions[i].et.size == 64 && !ex.extractions[i].et.backtrack) {
			printf("Found extraction that is likely to be reseed of batched_entropy");
            memcpy(&batched_entropy_long.entropy_long, ex.extractions[i].data, 64);
            batched_entropy_long.position = 0;
		}
	}

	// also find out when extractions happened and infer which process is running
    // go through running processes in /proc and get start time in /proc/<pid>/stat
    PROCTAB* proc = openproc(PROC_FILLMEM | PROC_FILLSTAT | PROC_FILLSTATUS);
    proc_t proc_info;
    memset(&proc_info, 0, sizeof(proc_info));
    while (readproc(proc, &proc_info) != NULL) {
        if (previous_read_time <= proc_info.start_time && proc_info.start_time <= current_read_time) {
            // this process was started between pulls from /dev/urandom

        }
    }
    closeproc(proc);
}
#include "common.h"

ul HZ;
ull btime_us;

inline ull timeval_to_us(struct timeval *tv) {
    return (1e6 * tv->tv_sec) + tv->tv_usec;
}

void init_timing(void) {
    int err; 
    HZ = sysconf(_SC_CLK_TCK);

    FILE *stat_file = fopen("/proc/stat", "r");
    char read_buf[128];
    while (fgets(read_buf, sizeof(read_buf), stat_file) != NULL) {
        if (read_buf[0] == 'b') {
            btime_us = strtoll(strchr(read_buf, ' ') + 1, NULL, 10) * 1e6;
            break;
        }
    }
    fclose(stat_file);

    printf("init_timing | HZ: %lu, btime_us: %llu\n", HZ, btime_us);
}

inline void jiffies_to_timeval(unsigned long jiffies, struct timeval *tv) {
    tv->tv_usec = (jiffies % HZ) * (1000000L / HZ);
    tv->tv_sec = jiffies / HZ;
}
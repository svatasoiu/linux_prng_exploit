/* utilities for getting info from /proc filesystem */
/* by: Sorin Vatasoiu */
#include <dirent.h>
#include <stdlib.h>
#include <sys/types.h>
#include <unistd.h>

#include "procs_utils.h"

int get_currently_running_pids(int **pids_ptr) {
    DIR *dir;
    int pid;
    struct dirent *entry;
    struct resizable_array pids;

    if ((dir = opendir("/proc")) == NULL) {
        return -1;
    }

    pids.n = 0;
    if (pids_ptr) {
        pids.arr = malloc(DEF_ARRAY_SIZE * sizeof(int));
        pids.capacity = DEF_ARRAY_SIZE;
        *pids_ptr = pids.arr;
    }

    while ((entry = readdir(dir)) != NULL) {
        if (is_digit(entry->d_name[0])) {
            if (pids_ptr && ((pid = atoi(entry->d_name)) > 0)) 
                add_to_array(pid, &pids);
        }
    }

    closedir(dir);
    return pids.n;
}

// no error checking here...
static void add_to_array(int pid, struct resizable_array *pids) {
    while (pids->n >= pids->capacity) {
        pids->arr = realloc(pids->arr, 2 * pids->capacity * sizeof(int));
        pids->capacity = 2 * pids->capacity;
    }
    pids->arr[pids->n++] = pid;
}